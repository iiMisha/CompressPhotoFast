# Workflow: Реализация кода

## Назначение

Это правило определяет обязательный workflow для реализации нового кода в проекте CompressPhotoFast.

---

## КРИТИЧЕСКИ ВАЖНОЕ ПРАВИЛО

**ВСЯ реализация кода ДОЛЖНА выполняться через специализированных субагентов.**

**ЗАПРЕЩЕНО:** Редактировать/создавать файлы в основном разговоре.

---

## Обязательный Workflow Implementation

### Шаг 0: Понимание задачи

1. Уточни требования у пользователя
2. Определи тип задачи (новая функция, bug fix, рефакторинг)
3. Выбери соответствующий специализированный агент

### Шаг 1: Исследование (ОБЯЗАТЕЛЬНЫЙ)

**ПЕРЕД любой реализацией ВСЕГДА исследуй код:**

```
// Используй ПРЯМЫЕ ИНСТРУМЕНТЫ (НЕ Task(Explore) - вызывает переполнение памяти!)

// Шаг 1.1: Найти похожие файлы
Glob("**/*[Компонент]*.kt")

// Шаг 1.2: Найти использование
Grep("[ключевое слово]", "**/*.kt")

// Шаг 1.3: Прочитать 2-5 файлов для паттернов
Read("путь/к/файлу1.kt")
Read("путь/к/файлу2.kt")

// Цель: Понять паттерны для реализации в том же стиле
```

### Шаг 2: Чтение Memory Bank (ОБЯЗАТЕЛЬНЫЙ)

**ПЕРЕД реализацией прочитай:**

1. `.claude/memory-bank/brief.md` - краткое описание проекта
2. `.claude/memory-bank/architecture.md` - архитектура приложения
3. `.claude/memory-bank/context.md` - текущий контекст
4. `.claude/rules/rules.md` - правила разработки

### Шаг 3: Планирование (для сложных задач)

Для сложных задач (много файлов, архитектурные решения):

```
Task(Plan, "medium", "
План реализации [функция]:
1. Какие файлы создать
2. Какие файлы изменить
3. Какие зависимости добавить
4. В каком порядке выполнять
5. Какие тесты написать
")
```

### Шаг 4: Реализация (ОБЯЗАТЕЛЬНО через субагента)

Выбери соответствующего агента:

#### Для Kotlin/Android:
```
Task(voltagent-lang:kotlin-specialist, "
Реализовать [функция] используя найденные паттерны:

КОНТЕКСТ ИЗ ИССЛЕДОВАНИЯ:
[вставь результаты из Explore]

РЕЗУЛЬТАТЫ ИССЛЕДОВАНИЯ:
- Найденный паттерн: [...]
- Используемые библиотеки: [...]
- Стиль кода: [...]

ТРЕБОВАНИЯ:
- [детальные требования]

АРХИТЕКТУРНЫЕ ОГРАНИЧЕНИЯ из Memory Bank:
- [ограничения из architecture.md]
")
```

#### Для других технологий:
- Python: `Task(voltagent-lang:python-pro)`
- JavaScript/TypeScript: `Task(voltagent-lang:javascript-pro)` или `Task(voltagent-lang:typescript-pro)`
- Java: `Task(voltagent-lang:java-architect)`
- C++: `Task(voltagent-lang:cpp-pro)`
- Rust: `Task(voltagent-lang:rust-engineer)`

### Шаг 5: Сборка (ОБЯЗАТЕЛЬНАЯ)

**ПОСЛЕ ЛЮБЫХ изменений кода - ОБЯЗАТЕЛЬНАЯ сборка:**

```
./gradlew assembleDebug
```

**Проверь:**
- [ ] Сборка завершилась успешно
- [ ] Нет warning'ов (или они допустимы)
- [ ] Нет ошибок компиляции

Если сборка failed:
- Сообщи об ошибке
- Исправь через субагента
- Пересобери снова

### Шаг 6: Тесты (если применимо)

Для критичного кода:
```
Task(voltagent-lang:kotlin-specialist, "
Написать тесты для [компонент]

Использовать паттерны из существующих тестов:
[результаты из исследования тестов]
")
```

---

## Детали по типам задач

### Новая функция

**Workflow:**
1. `Glob("**/[Компонент].kt")` + `Grep("...")` - найти похожие функции
2. Прочитать Memory Bank
3. `Task(voltagent-lang:kotlin-specialist, "Реализовать новую функцию")`
4. `./gradlew assembleDebug`
5. (Опционально) Написать тесты

### Исправление бага

**Workflow:**
1. `Grep("[ошибка|функция]", "**/*.kt")` - найти место с багом
2. Прочитать найденные файлы
3. Прочитать Memory Bank (особенно context.md)
4. `Task(voltagent-lang:kotlin-specialist, "Исправить баг")`
5. `./gradlew assembleDebug`
6. (Опционально) Написать regression тест

### Рефакторинг

**Workflow:**
1. `Glob("**/[Модуль]/*.kt")` - проанализировать весь модуль
2. `Task(Plan, "medium", "План рефакторинга")`
3. Прочитать Memory Bank (особенно architecture.md)
4. `Task(voltagent-lang:kotlin-specialist, "Выполнить рефакторинг")`
5. `./gradlew assembleDebug`
6. Убедиться что тесты проходят

### Написание тестов

**Workflow:**
1. `Glob("**/*Test.kt")` - найти существующие тесты
2. `Read` нескольких тестов для паттернов
3. `Task(voltagent-lang:kotlin-specialist, "Написать тесты следуя паттернам")`
4. `./gradlew test` или `./gradlew connectedAndroidTest`

---

## Передача контекста в субагента

### ✅ Правильный подход

```
// Шаг 1: Исследование через прямые инструменты
Grep("class.*ViewModel", "**/*.kt")
Read("app/src/main/java/com/compressphotofast/ui/MainViewModel.kt")
Read("app/src/main/java/com/compressphotofast/ui/SettingsViewModel.kt")

// [Получаем результаты: найдены 3 ViewModel с паттерном ...]

// Шаг 2: Реализация с контекстом
Task(voltagent-lang:kotlin-specialist, "
Реализовать CompressionViewModel следуя найденным паттернам:

НАЙДЕННЫЕ ПАТТЕРНЫ:
- Все ViewModel используют StateFlow для state
- Конструктор принимает Repository через DI
- Используются sealed class для событий

РЕАЛИЗОВАТЬ:
- CompressionViewModel с теми же паттернами
- State: CompressionState (sealed class)
- Events: CompressionEvent (sealed class)
")
```

### ❌ Неправильный подход

```
// Без исследования и контекста
Task(voltagent-lang:kotlin-specialist, "Реализовать CompressionViewModel")

// Риск: inconsistent с существующим кодом
```

---

## Интеграция с правилами проекта

### Связь с .claude/rules/rules.md

Из `rules.md` следует учитывать:

1. **Обязательная сборка** - после изменений кода
2. **Планирование** - указывать необходимость сборки в плане
3. **Язык общения** - русский для пользователя
4. **Memory Bank** - читать перед началом любой задачи

### Связь с Memory Bank

Из Memory Bank использовать:

- **brief.md** - понять общую концепцию проекта
- **architecture.md** - следовать архитектурным принципам
- **context.md** - учитывать текущий контекст и проблемы
- **tech.md** - использовать правильный tech stack

---

## Чек-лист для реализации

Перед началом реализации:
- [ ] Glob/Grep/Read выполнены для исследования паттернов
- [ ] Memory Bank файлы прочитаны
- [ ] Выбран правильный специализированный агент
- [ ] Подготовлен контекст для передачи в агента

Во время реализации:
- [ ] Реализация через специализированного агента
- [ ] Контекст из исследования передан в агента
- [ ] Паттерны из существующего кода применяются

После реализации:
- [ ] ./gradlew assembleDebug выполнен успешно
- [ ] Нет ошибок компиляции
- [ ] (Опционально) Тесты написаны и проходят
- [ ] (Опционально) Todo list обновлен

---

## Типичные ошибки и как их избежать

### ❌ Ошибка 1: Пропуск исследования
**НЕПРАВИЛЬНО:**
```
Сразу: Task(voltagent-lang:kotlin-specialist, "Реализовать")
```

**ПРАВИЛЬНО:**
```
Сначала: Glob + Grep + Read для поиска паттернов
Потом: Task(voltagent-lang:kotlin-specialist, "Реализовать используя паттерны")
```

### ❌ Ошибка 2: Игнорирование Memory Bank
**НЕПРАВИЛЬНО:**
```
Пропустить чтение Memory Bank файлов
```

**ПРАВИЛЬНО:**
```
Read .claude/memory-bank/*.md
Затем использовать эту информацию в реализации
```

### ❌ Ошибка 3: Отсутствие сборки
**НЕПРАВИЛЬНО:**
```
Закончить на реализации, не собрав проект
```

**ПРАВИЛЬНО:**
```
Реализация → ./gradlew assembleDebug → Проверка результатов
```

### ❌ Ошибка 4: Редактирование в основном разговоре
**НЕПРАВИЛЬНО:**
```
В основном разговоре: Edit file.kt
```

**ПРАВИЛЬНО:**
```
Task(voltagent-lang:kotlin-specialist, "Реализовать изменения")
```

---

## Примеры полного workflow

### Пример 1: Новая функция сжатия

```
// 1. Исследование через прямые инструменты
Glob("**/*Compressor*.kt")
Grep("interface Compressor", "**/*.kt")
Read("app/src/main/java/com/compressphotofast/compression/JpegCompressor.kt")

// 2. Чтение Memory Bank
Read .claude/memory-bank/architecture.md
Read .claude/rules/rules.md

// 3. Реализация
Task(voltagent-lang:kotlin-specialist, "
Реализовать WebPCompressor следуя паттернам существующих компрессоров:
- Использовать тот же интерфейс Compressor
- Следовать той же структуре кода
- Использовать те же зависимости (androidx, Coil и т.д.)
")

// 4. Сборка
./gradlew assembleDebug

// 5. Тесты
Task(voltagent-lang:kotlin-specialist, "Написать тесты для WebPCompressor")
./gradlew test
```

### Пример 2: Исправление бага

```
// 1. Исследование через прямые инструменты
Grep("compressImage|Ошибка", "**/*.kt")
Read("app/src/main/java/com/compressphotofast/util/ImageCompressionUtil.kt")

// 2. Чтение контекста
Read .claude/memory-bank/context.md

// 3. Исправление
Task(voltagent-lang:kotlin-specialist, "Исправить баг в сжатии изображений")

// 4. Сборка
./gradlew assembleDebug
```

---

**ЭТОТ WORKFLOW ОБЯЗАТЕЛЕН ДЛЯ ВСЕЙ РЕАЛИЗАЦИИ КОДА. БЕЗ ИСКЛЮЧЕНИЙ.**
