# Workflow: Работа с Memory Bank

## Назначение

Это правило определяет обязательный workflow для работы с Memory Bank проекта CompressPhotoFast.

---

## Что такое Memory Bank

**Memory Bank** - это папка `.claude/memory-bank/`, содержащая ключевую документацию проекта. После сброса контекста между сессиями это ЕДИНСТВЕННЫЙ источник информации о проекте.

### Статус Memory Bank

В начале каждой задачи указывайте статус:
- `[Memory Bank: Active]` - файлы прочитаны успешно
- `[Memory Bank: Missing]` - папка не существует или пуста

---

## Обязательные файлы Memory Bank

### Основные файлы (Обязательные)

| Файл | Лимит строк | Содержимое |
|------|-------------|------------|
| `brief.md` | **5 строк** | 1-2 предложения о проекте |
| `product.md` | **40 строк** | Требования к продукту |
| `context.md` | **50 строк** | Последние 5-7 изменений, текущее состояние |
| `architecture.md` | **80 строк** | Ключевые компоненты и связи |
| `tech.md` | **30 строк** | Основной tech stack |
| `tasks.md` | **100 строк** | Только актуальные задачи |

### Дополнительные файлы

- `memory-bank-instructions.md` - инструкции по работе с Memory Bank
- `context-archive.md` - архив старых изменений (опционально)

---

## Workflow: Чтение Memory Bank

### Когда читать Memory Bank

**ОБЯЗАТЕЛЬНО в начале КАЖДОЙ задачи:**

```
Read .claude/memory-bank/brief.md
Read .claude/memory-bank/context.md
Read .claude/memory-bank/architecture.md
Read .claude/memory-bank/tech.md
Read .claude/memory-bank/tasks.md
```

### Что делать после чтения

1. Кратко резюмируйте понимание проекта
2. Укажите текущий фокус работы (из context.md)
3. Учтите архитектурные ограничения (из architecture.md)
4. Используйте правильный tech stack (из tech.md)

**Пример:**
```
[Memory Bank: Active]

CompressPhotoFast - Android приложение для сжатия изображений.
Текущий фокус: рефакторинг системы сжатия.
Архитектура: MVVM + Clean Architecture, Hilt DI.
```

---

## Workflow: Инициализация Memory Bank

### Когда инициализировать

- При первом запуске проекта
- Когда папка `.claude/memory-bank/` не существует
- Когда пользователь запрашивает `initialize memory bank`

### Порядок инициализации

**КРИТИЧЕСКИ ВАЖНО:** Используйте ПРЯМЫЕ ИНСТРУМЕНТЫ вместо агента Explore (вызывает переполнение памяти).

```
// Шаг 1: Найти основные файлы через Glob
Glob("app/src/main/**/*.kt")
Glob("**/build.gradle.kts")
Glob("**/AndroidManifest.xml")
Glob("README.md")

// Шаг 2: Найти ключевые компоненты через Grep
Grep("class.*Activity|class.*Fragment|class.*ViewModel", "app/src/main/**/*.kt")
Grep("@Module|@InstallIn", "app/src/main/**/*.kt")

// Шаг 3: Прочитать ключевые файлы
Read("app/src/main/AndroidManifest.xml")
Read("app/build.gradle.kts")
Read("build.gradle.kts")

// Шаг 4: Создать Memory Bank файлы на основе результатов
```

### Создание файлов

На основе собранной информации создайте:

1. **brief.md** (макс 5 строк)
   ```markdown
   CompressPhotoFast - Android приложение для сжатия изображений.
   Архитектура: MVVM + Clean Architecture, Kotlin + Compose.
   ```

2. **product.md** (макс 40 строк)
   - Почему проект существует
   - Какие проблемы решает
   - Цели пользовательского опыта

3. **architecture.md** (макс 80 строк)
   - Системная архитектура
   - Пути к исходному коду
   - Ключевые технические решения

4. **tech.md** (макс 30 строк)
   - Используемые технологии
   - Настройка среды разработки

5. **context.md** (макс 50 строк)
   - Текущий фокус работы
   - Последние изменения

### Проверка после инициализации

Предложите пользователю:
- Прочитать созданные файлы
- Проверить точность описания
- Добавить отсутствующую информацию

---

## Workflow: Обновление Memory Bank

### Когда обновлять

1. После реализации значительных изменений
2. Когда пользователь запрашивает `update memory bank`
3. При обнаружении новых паттернов проекта
4. Когда требуется уточнение контекста

### Порядок обновления

**КРИТИЧЕСКИ ВАЖНО:** После ЛЮБОГО обновления проверяйте размер файлов.

#### Шаг 1: Исследование изменений

```
// Проверить git log для недавних изменений
Bash("git log --oneline -10 --name-only")

// Или найти недавние файлы через Glob
Glob("app/src/main/**/*.kt")
Glob("**/build.gradle.kts")
```

#### Шаг 2: Чтение текущих файлов

```
Read .claude/memory-bank/*.md
```

#### Шаг 3: Обновление файлов

Обновите соответствующие файлы на основе:
- Результатов исследования
- Текущего контекста
- Изменений в кодовой базе

#### Шаг 4: Проверка размера (КРИТИЧЕСКИ ВАЖНО)

**После ЛЮБОГО обновления:**

1. Посчитайте строки в каждом файле
2. Если превышен лимит:
   - В `context.md`: удалите самые старые изменения (оставьте последние 5-7)
   - В `tasks.md`: удалите выполненные/неактуальные задачи
   - В остальных файлах: сократите описания до essentials
3. Сообщите пользователю о сокращениях, если они были

#### Лимиты размера

| Файл | Лимит |
|------|-------|
| `brief.md` | 5 строк |
| `context.md` | 50 строк |
| `tasks.md` | 100 строк |
| `architecture.md` | 80 строк |
| `tech.md` | 30 строк |
| `product.md` | 40 строк |

---

## Правила компактности

### ✅ ДОПУСКАЕТСЯ

- Одно предложение вместо абзаца
- Краткие списки без подробностей
- Только факты (без "почему" и "как")
- Ссылки на внешнюю документацию
- Ключевые слова вместо фраз

### ❌ ЗАПРЕЩЕНО

- Примеры кода (только ссылки на файлы)
- Подробные объяснения
- Дублирование информации из других файлов
- Таблицы (используй списки)
- Многоуровневые вложенности

---

## Workflow: Добавление задачи

### Когда добавлять задачу

- Для повторяющихся задач (например, добавление новой функции)
- Когда пользователь запрашивает `add task` или `store this as a task`

### Формат задачи (КОМПАКТНЫЙ)

Максимум 15 строк на задачу:

```markdown
## Название задачи

**Когда**: Когда выполняется задача
**Файлы**: файл1.md, файл2.kt

**Шаги**:
1. Первый шаг
2. Второй шаг
3. Третий шаг

**Важно**: Критичное замечание
```

### ❌ ЗАПРЕЩЕНО в задачах

- Примеры кода (только ссылки на файлы)
- Подробные объяснения
- Дублирование информации

---

## Интеграция с другими workflows

### Перед реализацией кода

1. Прочитать Memory Bank файлы
2. `Glob` + `Grep` + `Read` для поиска паттернов (НЕ Task(Explore)!)
3. `Task(voltagent-lang:kotlin-specialist, "Реализовать")`

### После реализации кода

1. `./gradlew assembleDebug`
2. Если изменения значительные - предложить обновить Memory Bank

---

## Управление контекстным окном

Когда контекстное окно заполняется:

1. Предложите обновить memory bank
2. Рекомендуйте начать новую беседу/задачу
3. В новой беседе автоматически загрузятся файлы memory bank

---

## Чек-лист для работы с Memory Bank

### В начале задачи:
- [ ] Прочитаны ВСЕ файлы memory-bank/*.md
- [ ] Указан статус [Memory Bank: Active/Missing]
- [ ] Кратко резюмировано понимание проекта

### При инициализации:
- [ ] Использованы Glob/Grep/Read для анализа (НЕ Task(Explore)!)
- [ ] Созданы все основные файлы
- [ ] Проверены лимиты размера файлов
- [ ] Пользователь предложен проверить файлы

### При обновлении:
- [ ] Использованы Glob/Grep/Bash(git log) для поиска изменений
- [ ] Прочитаны текущие файлы memory bank
- [ ] Обновлены соответствующие файлы
- [ ] Проверены лимиты размера (КРИТИЧЕСКИ)
- [ ] Пользователь уведомлен о сокращениях (если были)

---

## Типичные ошибки

### ❌ Ошибка 1: Игнорирование Memory Bank

**НЕПРАВИЛЬНО:**
```
Начать задачу без чтения memory bank
```

**ПРАВИЛЬНО:**
```
Read .claude/memory-bank/*.md
Затем начать задачу с контекстом
```

### ❌ Ошибка 2: Превышение лимитов размера

**НЕПРАВИЛЬНО:**
```
Обновить context.md до 100 строк
```

**ПРАВИЛЬНО:**
```
После обновления проверить размер
Если превышен - удалить старые изменения
Оставить максимум 50 строк
```

### ❌ Ошибка 3: Прямое чтение всех файлов при инициализации

**НЕПРАВИЛЬНО:**
```
Read все файлы проекта напрямую
```

**ПРАВИЛЬНО:**
```
Glob + Grep + Read для анализа ключевых файлов
Создать файлы на основе результатов
```

---

**ЭТОТ WORKFLOW ОБЯЗАТЕЛЕН ДЛЯ ВСЕЙ РАБОТЫ С MEMORY BANK.**
