## План по реализации массовой обработки изображений

### 1. Цель

Реализовать надежный механизм для выбора и обработки более 10,000 изображений за один сеанс, обойдя ограничение стандартного `Intent.ACTION_SEND_MULTIPLE` (~500 изображений).

### 2. Ключевые изменения

Для достижения цели необходимо внедрить возможность выбора папки вместо отдельных файлов. Это позволит приложению самостоятельно сканировать содержимое папки и обрабатывать все найденные изображения.

1.  **Добавить кнопку "Выбрать папку" в UI**:
    *   **Файл**: `app/src/main/res/layout/activity_main.xml`
    *   **Действие**: Добавить новый элемент `Button` или `MaterialButton` рядом с существующими элементами управления.

2.  **Реализовать выбор папки через Storage Access Framework (SAF)**:
    *   **Файл**: `app/src/main/java/com/compressphotofast/ui/MainActivity.kt`
    *   **Действие**:
        *   Создать `ActivityResultLauncher` для интента `Intent.ACTION_OPEN_DOCUMENT_TREE`.
        *   По нажатию на новую кнопку "Выбрать папку" запускать этот лаунчер.
        *   В колбэке лаунчера получить URI выбранной директории.
        *   Сохранить постоянные права доступа к этой директории, чтобы иметь возможность работать с ней в фоновом режиме:
            ```kotlin
            val contentResolver = applicationContext.contentResolver
            contentResolver.takePersistableUriPermission(uri, Intent.FLAG_GRANT_READ_URI_PERMISSION)
            ```

3.  **Создать новый `Worker` для сканирования и обработки папки**:
    *   **Файл**: Создать `app/src/main/java/com/compressphotofast/worker/FolderProcessingWorker.kt`
    *   **Действие**:
        *   Создать новый класс `FolderProcessingWorker`, наследуемый от `CoroutineWorker`.
        *   `Worker` будет принимать URI папки в качестве входных данных (`inputData`).
        *   Реализовать рекурсивную функцию для обхода дерева документов (`DocumentFile.fromTreeUri(...)`) для поиска всех файлов изображений.
        *   Для каждого найденного изображения запускать существующую логику сжатия (вероятно, через `ImageProcessingUtil.handleImage` или напрямую ставя в очередь `ImageCompressionWorker`).
        *   `Worker` должен сообщать о прогрессе (количество найденных, обработанных, пропущенных файлов) через `setProgressAsync()`.

4.  **Запускать `Worker` и отслеживать прогресс**:
    *   **Файл**: `app/src/main/java/com/compressphotofast/ui/MainActivity.kt`
    *   **Действие**:
        *   После получения URI папки создать и поставить в очередь `OneTimeWorkRequest` для `FolderProcessingWorker`, передав ему URI.
        *   Использовать `WorkManager.getWorkInfoBy...()` для наблюдения за `WorkInfo` задачи.
        *   Обновлять UI (например, `ProgressBar`, текстовые поля со счетчиками) на основе данных о прогрессе, получаемых от `Worker`.

### 3. Логика работы

1.  **Пользовательский сценарий**:
    *   Пользователь нажимает новую кнопку "Выбрать папку" в `MainActivity`.
    *   Открывается системный файловый менеджер для выбора директории.
    *   Пользователь выбирает папку с фотографиями и нажимает "Разрешить".
    *   `MainActivity` получает URI папки и сохраняет права доступа.

2.  **Запуск фоновой задачи**:
    *   `MainActivity` создает `WorkRequest` для `FolderProcessingWorker`, передавая URI в `Data`.
    *   `WorkManager` ставит задачу в очередь на выполнение.
    *   На UI появляется индикатор прогресса (например, "Идет поиск изображений...").

3.  **Обработка в `FolderProcessingWorker`**:
    *   `Worker` запускается в фоновом потоке.
    *   Он использует `DocumentFile.fromTreeUri` для получения доступа к папке.
    *   Рекурсивно сканирует папку, собирая список URI всех найденных изображений (проверяя MIME-тип). На этом этапе `Worker` может обновлять прогресс (`WorkInfo`), сообщая общее количество найденных файлов.
    *   Собрав список, `Worker` начинает итерацию по нему и для каждого URI изображения запускает уже существующий `ImageCompressionWorker` (или использует `ImageProcessingUtil`).
    *   После обработки каждого файла `Worker` обновляет прогресс (`WorkInfo`), инкрементируя счетчик обработанных файлов.

4.  **Отображение результата**:
    *   `MainActivity` (или `MainViewModel`) наблюдает за `WorkInfo` и обновляет UI в реальном времени: `Обработано 123 из 10500...`.
    *   По завершении работы `Worker` `MainActivity` отображает итоговый результат, как это уже сделано для пакетной обработки.

Этот подход решает проблему ограничения `Intent`, так как передается только один URI (для папки), а вся остальная работа по поиску и обработке файлов инкапсулируется в надежном фоновом `Worker`.
