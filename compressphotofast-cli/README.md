# CompressPhotoFast CLI

Кроссплатформенный CLI-инструмент для быстрого сжатия изображений на Linux и Windows. Портирован из CompressPhotoFast Android-приложения с идентичной логикой сжатия.

## Возможности

- **Массовая обработка папок**: Рекурсивное сжатие целых папок
- **Сохранение EXIF**: Сохраняет все метаданные изображений (GPS, даты, настройки камеры)
- **Маркеры сжатия**: Отслеживает, какие файлы уже были сжаты, чтобы избежать повторного сжатия
- **Сохранение дат**: Сохраняет оригинальные даты изменения файлов
- **Несколько уровней качества**: Low (60), Medium (70), High (85) или автоопределение
- **Два режима сжатия**: Замена оригиналов или сохранение копий в подпапку
- **Умная фильтрация**: Пропуск скриншотов и фотографий из мессенджеров
- **Режим предварительного просмотра**: Предварительный просмотр сжатия без фактической обработки

## Установка

### Требования

- Python 3.10 или выше
- pip менеджер пакетов

### Установка зависимостей

```bash
cd compressphotofast-cli
pip install -r requirements.txt
```

## Использование

### Базовое сжатие

Сжать изображения в папке (сохраняет в подпапку `CompressPhotoFast/`):

```bash
python -m src.cli compress /path/to/photos
```

Сжать с указанным качеством:

```bash
python -m src.cli compress /path/to/photos --quality high
```

### Режимы сжатия

Заменить оригинальные файлы:

```bash
python -m src.cli compress /path/to/photos --replace
```

Сохранить в пользовательскую папку вывода:

```bash
python -m src.cli compress /path/to/photos --output-dir /path/to/output
```

### Уровни качества

- `low` (60) - Максимальное сжатие, низкое качество
- `medium` (70) - Сбалансированное сжатие (по умолчанию)
- `high` (85) - Высокое качество, умеренное сжатие
- `auto` - Автоматически определять оптимальное качество для каждого изображения

### Опции

```bash
python -m src.cli compress [PATH] [OPTIONS]

Options:
  -q, --quality [low|medium|high|auto]  Качество сжатия (по умолчанию: medium)
  -r, --replace                          Заменить оригинальные файлы
  -o, --output-dir PATH                  Папка для сохранения
  -s, --skip-screenshots                 Пропустить файлы скриншотов
  -m, --skip-messenger                   Пропустить фото из мессенджеров
  -f, --force                            Принудительное повторное сжатие
  -n, --dry-run                          Предварительный просмотр без сжатия
```

### Примеры

```bash
# Сжать текущую директорию с высоким качеством
python -m src.cli compress . --quality high

# Сжать с заменой оригиналов и пропуском скриншотов
python -m src.cli compress ./photos --replace --skip-screenshots

# Предварительный просмотр, чтобы увидеть, что будет сжато
python -m src.cli compress ./photos --dry-run

# Сжать один файл
python -m src.cli compress photo.jpg --quality medium

# Посмотреть статистику об изображениях
python -m src.cli stats ./photos

# Показать версию
python -m src.cli version
```

### Команда статистики

Показать статистику об изображениях в директории:

```bash
python -m src.cli stats /path/to/photos
```

## Логика сжатия

CLI сохраняет идентичную логику с Android-приложением:

### Настройки качества

| Уровень | Качество | Описание |
|---------|----------|-----------|
| Low | 60 | Максимальное сжатие, экономия 30%+ |
| Medium | 70 | Сбалансированное, экономия 30%+ |
| High | 85 | Высокое качество, экономия 30%+ |

### Правила сжатия

- Минимальный размер файла: 100 КБ (меньшие файлы пропускаются)
- Минимальное сжатие: 30% уменьшение размера + 10 КБ абсолютной экономии
- Файлы с размером менее 100 КБ считаются уже оптимизированными и пропускаются
- Маркер EXIF предотвращает повторное сжатие, если файл не изменен
- Измененные файлы (с существующим маркером) сжимаются повторно, если разница > 20 секунд

### Обработка EXIF

- **Маркер сжатия**: `CompressPhotoFast_Compressed:качество:timestamp` в теге UserComment
- **Сохраняемые данные**: Все теги EXIF включая GPS, даты, камеру, экспозицию
- **Даты файлов**: Оригинальные даты изменения/создания сохраняются
- **Умное пропуска**: Файлы с маркерами пропускаются, если не были изменены

## Совместимость

### Поддерживаемые форматы

- JPEG (.jpg, .jpeg)
- PNG (.png)
- HEIC/HEIF (.heic, .heif) - конвертируются в JPEG

### Поддерживаемые платформы

- Linux
- Windows
- macOS (не протестировано)

## Вывод

### Итоги сжатия

После обработки вы увидите сводку:

```
┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┓
┃ Metric          ┃ Value    ┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━┩
│ Total files     │ 125      │
│ Processed       │ 125      │
│ Success         │ 100      │
│ Skipped         │ 25       │
│ Failed          │ 0        │
│ Original size   │ 523.5 MB │
│ Compressed size │ 315.2 MB │
│ Saved           │ 208.3 MB │
│ Saved %         │ 39.8%    │
└─────────────────┴──────────┘
```

## Решение проблем

### "Изображения не найдены"

- Проверьте, существует ли путь и содержит ли он поддерживаемые файлы изображений
- Попробуйте запустить без флагов `--skip-screenshots` или `--skip-messenger`

### "Сжатие неэффективно"

Файл недостаточно хорошо сжимается (менее 30% уменьшения). Это нормально для уже оптимизированных изображений.

### Ошибки прав доступа

- Убедитесь, что у вас есть права записи в папку вывода
- Режим `--replace` требует прав записи для исходных файлов

## Разработка

### Структура проекта

```
compressphotofast-cli/
├── src/
│   ├── __init__.py
│   ├── cli.py              # CLI интерфейс (Click)
│   ├── compression.py      # Логика сжатия
│   ├── exif_handler.py     # Работа с EXIF
│   ├── file_utils.py       # Утилиты для файлов
│   └── constants.py        # Константы приложения
├── requirements.txt
└── README.md
```

### Ключевые компоненты

- **ImageCompressor**: Обрабатывает сжатие JPEG/PNG с помощью Pillow
- **ExifHandler**: Управляет данными EXIF с библиотекой piexif
- **CompressionStats**: Отслеживает результаты сжатия
- **CompressionResult**: Представляет результат одиночного сжатия

## Лицензия

Портировано из CompressPhotoFast Android-приложения.

## Благодарности

Оригинальное Android-приложение: CompressPhotoFast
