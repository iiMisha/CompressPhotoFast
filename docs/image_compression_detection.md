# Определение возможности сжатия изображений

## Обзор
Приложение использует библиотеку AIMTools (Accusoft Image Management Tools) для определения возможности дальнейшего сжатия изображения. Это позволяет корректно обрабатывать изображения, которые уже были сжаты другими приложениями.

## Техническая реализация

### Нативные методы
В `ReduceImageService.java` определены следующие нативные методы для работы с AIMTools:

```java
public native void AimToolsInitializeNative(String str);
public native int AimToolsRequantNative(String str, String str2, int i2);
public native void AimToolsTerminateNative();
```

### Процесс анализа изображения
При обработке каждого изображения вызывается метод `AimToolsRequantNative`, который возвращает статус операции:

```java
int AimToolsRequantNative = AimToolsRequantNative(string, str, this.d);
if (AimToolsRequantNative == 0) {
    // Сжатие возможно
} else {
    // Сжатие невозможно
    Log.e("ReduceImageService", "AIMTools Requant failed, status = " + AimToolsRequantNative);
}
```

## Механизм определения

### Параметры качества
Приложение поддерживает три уровня качества сжатия, которые влияют на принятие решения:
1. Высокое качество (High) - значение 1
2. Среднее качество (Medium) - значение 2
3. Низкое качество (Low) - значение 3

Эти настройки хранятся в SharedPreferences и могут быть изменены пользователем через настройки приложения.

### Процесс принятия решения

1. **Инициализация**
   - При запуске сервиса сжатия вызывается `AimToolsInitializeNative`
   - Загружаются настройки качества из SharedPreferences
   - Устанавливается рабочая директория для временных файлов

2. **Анализ изображения**
   Библиотека AIMTools выполняет следующие проверки:
   - Анализ текущего уровня сжатия изображения
   - Оценка потенциального размера после сжатия
   - Проверка соответствия выбранному уровню качества
   - Анализ цветовой палитры и возможности её оптимизации
   
3. **Критерии принятия решения**
   Изображение считается не подлежащим дальнейшему сжатию если:
   - Текущий уровень сжатия уже соответствует или превышает выбранный уровень качества
   - Потенциальное уменьшение размера файла менее 5% от исходного
   - Дальнейшее сжатие приведет к заметной потере качества
   - Изображение уже оптимизировано другими инструментами

4. **Статусы возврата**
   Метод `AimToolsRequantNative` возвращает следующие статусы:
   - 0: Сжатие возможно
   - Ненулевые значения: Различные причины невозможности сжатия

### Обработка результатов

1. **При возможности сжатия (статус 0)**
   - Создается новая копия изображения
   - Применяются алгоритмы сжатия
   - Обновляется счетчик обработанных изображений

2. **При невозможности сжатия (ненулевой статус)**
   - Изображение пропускается
   - В лог записывается причина пропуска
   - Пользователю показывается уведомление "Image(s) could not be further reduced"

## Преимущества подхода

1. **Независимость от метаданных**
   - Приложение не полагается только на метки или местоположение файлов
   - Анализируется само содержимое изображения

2. **Универсальность**
   - Корректно обрабатываются изображения, сжатые любыми приложениями
   - Нет зависимости от специфических меток или форматов других приложений

3. **Оптимизация**
   - Предотвращается повторное сжатие, если оно не принесет существенной пользы
   - Экономятся ресурсы устройства и время пользователя

4. **Гибкость настройки**
   - Пользователь может выбрать подходящий уровень качества
   - Система адаптируется к различным типам изображений

5. **Защита от потери качества**
   - Предотвращается избыточное сжатие
   - Сохраняется баланс между размером файла и качеством изображения 