# Задачи проекта CompressPhotoFast

## Текущая задача: Исправление логики замены оригинальных файлов при обработке Intent

**Уровень сложности:** Level 2 (Simple Enhancement)

**Статус:** Завершена
- [x] Инициализация завершена
- [x] Планирование завершено
- [x] Реализация завершена
- [x] Рефлексия завершена
- [x] Архивирование завершено

## Архив
- **Дата**: 2025-07-27
- **Архивный документ**: docs/archive/reflection_2025-07-27_11-17-14.md
- **Статус**: ЗАВЕРШЕНО

### Описание проблемы
При получении изображений через Intent.ACTION_SEND и Intent.ACTION_SEND_MULTIPLE настройка "Заменять оригинальные файлы" не применяется корректно. Сжатые изображения создаются как новые файлы вместо замены оригинальных.

### Анализ кодовой базы

#### 1. Точка входа для Intent
- **Файл:** `MainActivity.kt`
- **Методы:** 
  - `handleIntent()` - обрабатывает входящие Intent
  - `extractUrisFromIntent()` - извлекает URI из Intent
- **Поведение:** Принудительно обрабатывает изображения через `ImageProcessingUtil.handleImage()` с флагом `forceProcess = true`

#### 2. Цепочка обработки
1. `MainActivity.handleIntent()` → 
2. `ImageProcessingUtil.handleImage()` → 
3. `ImageCompressionWorker.doWork()` → 
4. `MediaStoreUtil.saveCompressedImageFromStream()`

#### 3. Текущая логика настройки замены
- **Файл:** `SettingsManager.kt`
- **Методы:** `isSaveModeReplace()`, `setSaveMode()`
- **Применение:** 
  - В `MediaStoreUtil.saveCompressedImageFromStream()` - определяет директорию сохранения
  - В `ImageCompressionWorker` - переименование и удаление оригинала
  - В `MediaStoreUtil.createMediaStoreEntry()` - обработка конфликтов имен

#### 4. Проблемные места
- Настройка замены применяется, но логика может работать некорректно для файлов, полученных через Intent
- Возможны проблемы с правами доступа к файлам из других приложений
- Логика переименования оригинала может не работать для внешних URI

### План реализации

#### Этап 1: Детальный анализ
- [x] Изучить точку входа для Intent в MainActivity
- [x] Проанализировать цепочку обработки изображений
- [x] Изучить текущую логику применения настройки замены
- [ ] Протестировать текущее поведение с включенной/выключенной настройкой

#### Этап 2: Выявление проблем
- [ ] Определить, где именно ломается логика замены для Intent
- [ ] Проверить права доступа к файлам из других приложений
- [ ] Выявить различия в обработке локальных файлов vs файлов из Intent

#### Этап 3: Реализация исправлений
- [ ] Скорректировать логику определения возможности замены файла
- [ ] Обновить обработку файлов, полученных через Intent
- [ ] Добавить специальную логику для внешних URI

#### Этап 4: Тестирование
- [ ] Тест с одним изображением через ACTION_SEND (настройка включена)
- [ ] Тест с одним изображением через ACTION_SEND (настройка выключена)
- [ ] Тест с несколькими изображениями через ACTION_SEND_MULTIPLE (настройка включена)
- [ ] Тест с несколькими изображениями через ACTION_SEND_MULTIPLE (настройка выключена)

### Технические детали

#### Ключевые файлы
- `MainActivity.kt` - точка входа для Intent
- `ImageProcessingUtil.kt` - централизованная обработка
- `ImageCompressionWorker.kt` - фоновое сжатие
- `MediaStoreUtil.kt` - сохранение файлов
- `SettingsManager.kt` - управление настройками
- `FileOperationsUtil.kt` - операции с файлами

#### Ключевые методы
- `MainActivity.handleIntent()`
- `MediaStoreUtil.saveCompressedImageFromStream()`
- `FileOperationsUtil.isSaveModeReplace()`
- `FileOperationsUtil.renameOriginalFileIfNeeded()`

### Следующие шаги
1. Протестировать текущее поведение приложения
2. Выявить конкретные проблемы в логике
3. Реализовать исправления
4. Провести комплексное тестирование